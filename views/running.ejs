<form action="/running" method="post">
    <div></div>
    <input name="score" type="hidden">
    <input name="allLatitudes" type="hidden">
    <input name="allLongitudes" type="hidden">
    <input name="allTimestamps" type="hidden">
    <input name="allPaces" type="hidden">
    <input name="totalDistance" type="hidden">
    <button type="button" onclick="start()">Start</button>
    <button type="submit" onclick="end()">End</button>
</form>

<script>
    // const dis_score = document.querySelectorAll("div")[0];
    let score = 0;
    let latitude, longitude, currentTimestamp, startTime, previousPosition, totalDistance=0, totalTime;
    let setTimeout_id;
    let allLatitudes = [];
    let allLongitudes = [];
    let allTimestamps = [];
    let allPaces = [];
    function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371.0; // 지구 반지름 (킬로미터)
        const toRadians = (degree) => degree * (Math.PI / 180);

        const dLat = toRadians(lat2 - lat1);
        const dLon = toRadians(lon2 - lon1);

        const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
            Math.sin(dLon / 2) ** 2;

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // 킬로미터 단위 거리 반환
    }

    function calculatePace(distance, timeSeconds) {
        if (distance === 0) return 0;
        return timeSeconds / distance / 60; // 초/킬로미터
    }

    async function start(){
        const position = await(new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
        }));
        latitude = position.coords.latitude;
        longitude = position.coords.longitude;
        currentTimestamp = Date.now();

        if (!startTime) {
            startTime = currentTimestamp;
        }

        if (previousPosition) {
            const distance = haversine(
                previousPosition.latitude,
                previousPosition.longitude,
                latitude,
                longitude
            );

            totalDistance += distance;
            totalTime = (currentTimestamp - startTime) / 1000; // 초 단위
            const pace = calculatePace(totalDistance, totalTime);

            console.log(`Distance: ${totalDistance.toFixed(2)} km, Time: ${totalTime.toFixed(0)} s, Pace: ${pace.toFixed(2)} min/km`);
            document.querySelectorAll('div')[0].innerText = `Distance: ${totalDistance.toFixed(2)} km, Time: ${totalTime.toFixed(1)} s, Pace: ${pace.toFixed(2)} min/km, Score: ${score}`;
            
            allLatitudes.push(latitude);
            allLongitudes.push(longitude);
            allTimestamps.push(currentTimestamp);
            allPaces.push(pace);
        }

        previousPosition = { latitude, longitude };
        previousTimestamp = currentTimestamp;

        score++;
        setTimeout_id = setTimeout(start,100)
    }

    function end(){
        const post = document.querySelectorAll("input");
        post[0].value = score;
        post[1].value = allLatitudes;
        post[2].value = allLongitudes;
        post[3].value = allTimestamps;
        post[4].value = allPaces;
        post[5].value = totalDistance;

        clearTimeout(setTimeout_id);
    }

</script>